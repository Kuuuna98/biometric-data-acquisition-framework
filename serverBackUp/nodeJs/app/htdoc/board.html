<!doctype html>
<html>
<head>
	<title>Socket.IO chat</title>
	<link type="text/css" rel="stylesheet" href="board.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
	<script src="/socket.io/socket.io.js"></script>

	
	<script>
		
	var data = {};
	var newCol = true;
	var headers = null;

	$(function () {
		var socket = io();

		socket.on('ack', function(msg){
			var payload = JSON.parse(msg);
			var device = data[payload.setNumber];
			if (device == null) {
				device = { setNumber: payload.setNumber };
				data[payload.setNumber] = device;
			}
			payload.reg = new Date().getTime();
			updateMerge(device, payload);

			reloadView();
		});

		socket.on('message', function(msg){
			console.log(JSON.parse(msg));
		});

		setInterval(reloadView, 1000);
	});

	function reloadView() {
		if (newCol) {
			$("#dataView thead").empty();
			$("#dataView tbody").empty();
			$("#dataView tfoot").empty();

			headers = getCols();

			var $tr1 = $("<tr></tr>");
			var $tr2 = $("<tr></tr>");
			var $trt = $("<tr class='dataTemp'></tr>");
			$("#dataView thead").append($tr1).append($tr2);
			$("#dataView tfoot").append($trt);

			$tr1.append("<td rowspan=2>UDID(setNumber)</td>");
			$trt.append("<td dataAttr='setNumber'><b>#setNumber</b></td");

			for (var i = 0; i < headers.list.length; i++) {
				$tr1.append("<td colspan=" + headers.attrs[headers.list[i]].length + ">" + headers.list[i] + "</td>");
				for (var j = 0; j < headers.attrs[headers.list[i]].length; j++) {
					$tr2.append("<td>" + headers.attrs[headers.list[i]][j] + "</td>");
					$trt.append("<td deviceAttr='" + headers.list[i] + "' dataAttr='" + headers.attrs[headers.list[i]][j] + "'>" + headers.attrs[headers.list[i]][j] + "</td");
				}
			}
			newCol = false;
		}

		var setNumberList = Object.keys(data);
		for (var i = 0; i < setNumberList.length; i++) {
			var dt = data[setNumberList[i]];
			var $tr = $("#dataView tbody tr[setNumber='" + dt.setNumber + "']");
			if ($tr.length == 0) {
				// need new tr
				$tr = $("#dataView tfoot .dataTemp").clone();
				$tr.removeClass("dataTemp");
				$tr.attr("setNumber", dt.setNumber);
				$tr.find("td[dataAttr='setNumber'] b").text(dt.setNumber);
				$("#dataView tbody").append($tr);
			}

			$tr.find("td[deviceAttr]").each(function(i, $td) {
				$td = $($td);
				try {
					var value = dt[$td.attr("deviceAttr")][$td.attr("dataAttr")];
					if ($td.attr("dataAttr") == "reg") {
						value = Math.round((new Date().getTime() - value) / 1000);
						if (value > 60) {
							$td.css("color", "white").css("background-color", "red");
						} else {
							$td.css("color", "black").css("background-color", "white");
						}
					}
					$td.text(value);
				} catch (e) {
					$td.text("-");
				}
			});

		}
	}

	function updateMerge(device, payload) {
		if (payload.deviceType == null) {
			console.log("ERR No device type");
			return;
		}
		newCol |= device[payload.deviceType] == null;

		device[payload.deviceType] = payload;
	}
	function getCols() {
		var list = [];
		var deviceAttrs = {};
		var k = Object.keys(data);
		for (var ki in k) {
			var setNumber = k[ki];
			var dk = Object.keys(data[setNumber]);
			for (var di in dk) {
				var deviceType = dk[di];
				if (deviceType == "setNumber") continue;
				if (list.indexOf(deviceType) == -1) {
					list.push(deviceType);
					deviceAttrs[deviceType] = Object.keys(data[setNumber][deviceType])
													.filter(function(value) {
														return ["setNumber", "deviceType"].indexOf(value) == -1;
													});
				}
			}
		}
		list.sort();
		return { list: list, attrs: deviceAttrs };
	}
	</script>

</head>
<body>
	<table id="dataView">
		<thead>
			<tr>
				<th>UDID(setNumber)</th>
			</tr>
		</thead>
		<tbody></tbody>
		<tfoot></tfoot>
	</table>
	<script type="javascript" rel="script" src="board.js"></script>
</body>
</html>
    